name: Perl CI

on:
  push:
    branches:
      - "*"
    tags-ignore:
      - "*"
  pull_request:

jobs:
  ubuntu:
    env:
      PERL_USE_UNSAFE_INC: 0
      AUTHOR_TESTING: 1
      AUTOMATED_TESTING: 1
      RELEASE_TESTING: 1

    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v1
      
      - name: perl -V
        run: perl -V

      - name: install dependencies
        uses: perl-actions/install-with-cpanm@stable
        with:
          cpanfile: "cpanfile"
          sudo: false
        
      - name: Makefile.PL
        run: perl Makefile.PL TT_QUIET=n TT_ACCEPT=y
      
      - name: make test
        run: make test
      
      - name: make install
        run: sudo make install

  linux:
    name: "linux ${{ matrix.perl-version }}"
    needs: [ubuntu]
    env:
      PERL_USE_UNSAFE_INC: 0
      AUTHOR_TESTING: 1
      AUTOMATED_TESTING: 1
      RELEASE_TESTING: 1

    runs-on: ubuntu-latest

    strategy:
      fail-fast: false
      matrix:
        XS: [y, n]
        perl-version:
          [
            "5.32",
            "5.30",
            "5.28",
            "5.26",
            "5.24",
            "5.22",
            "5.20",
            "5.18",
            "5.16",
            "5.14",
            "5.12",
            "5.10",
            "5.8",
          ]

    container:
      image: perl:${{ matrix.perl-version }}

    steps:
      - uses: actions/checkout@v2
      - name: perl -V
        run: perl -V
      - name: install dependencies
        uses: perl-actions/install-with-cpm@v1.3
        with:
          sudo: false
          cpanfile: "cpanfile"
      - name: Makefile.PL
        run: perl Makefile.PL TT_XS_DEFAULT=${{ matrix.XS }} TT_XS_ENABLE=${{ matrix.XS }} TT_QUIET=n TT_ACCEPT=y
      - name: make test
        run: make test
      - name: make install
        run: make install

  macOS:
    needs: [ubuntu]
    env:
      PERL_USE_UNSAFE_INC: 0
      AUTHOR_TESTING: 1
      AUTOMATED_TESTING: 1
      RELEASE_TESTING: 1

    runs-on: macOS-latest

    strategy:
      fail-fast: false
      matrix:
        perl-version: [latest]
        XS: [y, n]

    steps:
      - uses: actions/checkout@v2
      - name: perl -V
        run: perl -V
      - name: install dependencies
        uses: perl-actions/install-with-cpm@v1.3
        with:
          sudo: false
          cpanfile: "cpanfile"
      - name: Makefile.PL
        run: perl Makefile.PL TT_XS_DEFAULT=${{ matrix.XS }} TT_XS_ENABLE=${{ matrix.XS }} TT_QUIET=n TT_ACCEPT=y
      - name: make test
        run: make test

  plugins:
    needs: [ubuntu,linux]
    env:
      # some plugins still needs this to run their tests...
      PERL_USE_UNSAFE_INC: 1
      AUTHOR_TESTING: 0
      AUTOMATED_TESTING: 0
      RELEASE_TESTING: 0

    runs-on: ubuntu-latest

    name: "${{ matrix.plugin }} XS=${{ matrix.XS }}"

    strategy:
      fail-fast: false
      matrix:
        plugin:
          - 'Template::Plugin::Autoformat'
          - 'Template::Plugin::Cache'
          - 'Template::Plugin::Comma'
          - 'Template::Plugin::CSV'
          - 'Template::Plugin::DateTime'
          - 'Template::Plugin::DBI'
          - 'Template::Plugin::Dump'
          - 'Template::Plugin::encoding'
          - 'Template::Plugin::Gettext'
          - 'Template::Plugin::HTML::Template'
          - 'Template::Plugin::JavaScript'
          - 'Template::Plugin::JSON'
          - 'Template::Plugin::Map'
          - 'Template::Plugin::Markdown'
          - 'Template::Plugin::MIME'
          - 'Template::Plugin::TimeDate'
          - 'Template::Plugin::URI'
          - 'Template::Plugin::XML'
          - 'Template::Provider::FromDATA'
        perl-version:
          - 'latest'
        XS: [y, n]

    container:
      image: perl:${{ matrix.perl-version }}

    steps:
      - uses: actions/checkout@v2
      - name: perl -V
        run: perl -V
      - name: Install cpm
        run: cpanm -n App::cpm Carton::Snapshot
      - name: Install Dependencies
        run: cpm install -g --no-test --show-build-log-on-failure --cpanfile cpanfile.plugins
      - name: Makefile.PL
        run: perl Makefile.PL TT_XS_DEFAULT=${{ matrix.XS }} TT_XS_ENABLE=${{ matrix.XS }} TT_QUIET=n TT_ACCEPT=y
      - name: make install
        run: make install
      # Try to install multiple plugins to confirm we do not break them
      - name: install plugin
        run: cpm install -g --test --show-build-log-on-failure ${{ matrix.plugin }}


# on:
#   push:
#     branches:
#       - main
#       - master
#       - develop
#   pull_request:
#     branches:
#       - main
#       - master
#       - develop

# jobs:
#   build:
#     runs-on: ubuntu-latest

#     steps:
#     - name: Checkout repository
#       uses: actions/checkout@v2

#     - name: Set up Perl
#       uses: shogo82148/actions-setup-perl@v1
#       with:
#         perl-version: '5.34'  # Adjust the Perl version as needed

#     - name: Update CPAN and install App::cpanminus
#       run: |
#         perl -MCPAN -e 'install CPAN'
#         perl -MCPAN -e 'install App::cpanminus'

#     - name: Install build-essential
#       run: |
#         sudo apt-get update
#         sudo apt-get install -y build-essential

#     - name: Run custom configuration (if needed)
#       run: |
#         wget https://cpan.metacpan.org/authors/id/A/AU/AUTHOR/Module-Name-1.23.tar.gz
#         tar -zxvf Module-Name-1.23.tar.gz
#         cd Module-Name-1.23
#         chmod +x Makefile.PL
#         perl Makefile.PL
#         make

#     - name: Install dependencies using cpanm
#       run: cpanm --installdeps .

#     - name: Run tests
#       run: prove -l t

#     - name: Show Errors on Ubuntu
#       if: ${{ failure() && startsWith(matrix.runner, 'ubuntu-') }}
#       run: cat /home/runner/.cpanm/work/*/build.log
 
#     - name: Show Errors on OSX
#       if: ${{ failure() && startsWith(matrix.runner, 'macos-') }}
#       run: cat /Users/runner/.cpanm/work/*/build.log

#     - name: Upload coverage reports to Codecov
#       uses: codecov/codecov-action@v3
#       env:
#         CODECOV_TOKEN: ${{ secrets.CODECOV_TOKEN }}